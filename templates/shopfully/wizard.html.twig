{% extends 'base.html.twig' %}

{% block title %}Shopfully Wizard{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <style>
        .stepper {
            display: flex;
            justify-content: space-between;
            position: relative;
            margin-bottom: 2rem;
        }

        .stepper::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 3px;
            background-color: #e0e0e0;
            z-index: 0;
        }

        .stepper-step {
            position: relative;
            z-index: 1;
            text-align: center;
            flex: 1;
        }

        .stepper-circle {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            margin: 0 auto 0.5rem;
            background-color: #e0e0e0;
            color: #fff;
            line-height: 30px;
            font-weight: bold;
        }

        .stepper-step.active .stepper-circle,
        .stepper-step.completed .stepper-circle {
            background-color: #007bff;
        }

        .stepper-step.completed .stepper-circle::after {
            content: 'âœ“';
        }

        .stepper-label {
            font-size: 0.9rem;
            color: #555;
        }

        .stepper-step.active .stepper-label {
            font-weight: bold;
            color: #007bff;
        }

        .btn-loading {
            pointer-events: none;
            opacity: 0.7;
            position: relative;
        }

        .btn-loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 1.25rem;
            height: 1.25rem;
            border: 2px solid transparent;
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
            transform: translate(-50%, -50%);
        }

        @keyframes spin {
            to { transform: translate(-50%, -50%) rotate(360deg); }
        }
        .select2-selection.is-invalid {
            border-color: #dc3545 !important;
            box-shadow: 0 0 0 0.25rem rgba(220,53,69,.25);
        }


    </style>

{% endblock %}

{% block body %}
    <div class="container mt-5">
        <h1 class="text-center mb-4">Shopfully Wizard</h1>

        {% for message in app.flashes('success') %}
            <div class="alert alert-success">{{ message }}</div>
        {% endfor %}

        <!-- Tab Navigation -->
        <ul class="nav nav-tabs mb-3" id="wizardTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="form-tab" data-bs-toggle="tab" data-bs-target="#form-tab-pane" type="button" role="tab">
                    Wizard Form
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="logs-tab" data-bs-toggle="tab" data-bs-target="#logs-tab-pane" type="button" role="tab">
                    Logs
                </button>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content p-3 border rounded bg-white" id="wizardTabsContent">
            <!-- Form Tab -->
            <div class="tab-pane fade show active" id="form-tab-pane" role="tabpanel">
                <div class="stepper" id="stepper">
                    <div class="stepper-step" data-step="0">
                        <div class="stepper-circle">1</div>
                        <div class="stepper-label">Owner</div>
                    </div>
                    <div class="stepper-step" data-step="1">
                        <div class="stepper-circle">2</div>
                        <div class="stepper-label">Company</div>
                    </div>
                    <div class="stepper-step" data-step="2">
                        <div class="stepper-circle">3</div>
                        <div class="stepper-label">Locale & Brochures</div>
                    </div>
                    <div class="stepper-step" data-step="3">
                        <div class="stepper-circle">4</div>
                        <div class="stepper-label">Preview</div>
                    </div>
                </div>

                {{ form_start(form) }}

                <div id="step-0" class="step">
                    <h4>Step 1: Select Owner</h4>
                    <div class="mb-3">
                        {{ form_label(form.owner) }}
                        {{ form_widget(form.owner, {'attr': {
                            'class': 'form-control',
                            'required': 'required',
                            'data-error-message': 'Please select an owner'
                        }}) }}
                        {{ form_errors(form.owner) }}
                        {{ form_row(form.timezone) }}

                    </div>
                    <button type="button" class="btn btn-primary" onclick="nextStep(1)">Next</button>
                </div>

                <div id="step-1" class="step" style="display: none;">
                    <h4>Step 2: Select Company</h4>
                    <div class="mb-3">
                        {{ form_label(form.company) }}
                        {{ form_widget(form.company, {'attr': {
                            'class': 'form-control',
                            'required': 'required',
                            'data-error-message': 'Please select a company'
                        }}) }}
                        {{ form_errors(form.company) }}
                    </div>
                    <button type="button" class="btn btn-primary" onclick="nextStep(2)">Next</button>
                </div>

                <div id="step-2" class="step" style="display: none;">
                    <h4>Step 3: Locale and Brochures</h4>

                    <div class="mb-3">
                        {{ form_label(form.locale) }}
                        {{ form_widget(form.locale, {'attr': {'class': 'form-control'}}) }}
                        {{ form_errors(form.locale) }}
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Duplicate brochures with Prefix and/or Suffix</label>
                        <div class="row g-2">
                            <div class="col-md-6">
                                {{ form_widget(form.prefix, {'attr': {'placeholder': 'Prefix'}}) }}
                            </div>
                            <div class="col-md-6">
                                {{ form_widget(form.suffix, {'attr': {'placeholder': 'Suffix'}}) }}
                            </div>
                        </div>
                    </div>


                    <div class="mb-3">
                        {% set prototype %}
                            <div class="number-entry mb-2">
                                <div class="row g-2">
                                    <div class="col">
                                        {{ form_widget(form.numbers.vars.prototype.number, {'attr': {'class': 'form-control', 'placeholder': 'Number'}}) }}
                                    </div>
                                    <div class="col">
                                        {{ form_widget(form.numbers.vars.prototype.tracking_pixel, {'attr': {'class': 'form-control', 'placeholder': 'Tracking Pixel'}}) }}
                                    </div>
                                </div>
                            </div>
                        {% endset %}

                        <div id="numbers-wrapper" data-prototype="{{ prototype|e('html_attr') }}">
                            {% for entry in form.numbers %}
                                <div class="number-entry mb-2" data-real="true">
                                    <div class="row g-2">
                                        <div class="col">
                                            {{ form_widget(entry.number, {'attr': {'class': 'form-control'}}) }}
                                        </div>
                                        <div class="col">
                                            {{ form_widget(entry.tracking_pixel, {'attr': {'class': 'form-control'}}) }}
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                        <div class="mb-2">
                            <label for="bulkNumbers" class="form-label">Enter brochure numbers separated by commas</label>
                            <input type="text" id="bulkNumbers" class="form-control" placeholder="e.g. 123,456,789">
                        </div>

                        <button type="button" class="btn btn-outline-primary mt-2" onclick="addNumberField()">Add Brochure</button>
                    </div>

                    <div class="d-flex justify-content-between">
                        <button type="button" class="btn btn-secondary" onclick="prevStep()">Previous</button>
                        <button type="button" class="btn btn-primary" onclick="nextStep(3)">Next</button>
                    </div>
                </div>

                <div id="step-3" class="step" style="display: none;">
                    <h4>Step 4: Preview</h4>
                    <div class="mb-2"><strong>Company:</strong> <span id="preview-company"></span></div>
                    <div class="mb-2"><strong>Locale:</strong> <span id="preview-locale"></span></div>
                    <div class="mb-2"><strong>Prefix:</strong> <span id="preview-prefix"></span></div>
                    <div class="mb-2"><strong>Suffix:</strong> <span id="preview-suffix"></span></div>
                    <div class="mb-2"><strong>Brochures:</strong> <ul id="preview-numbers" class="list-group"></ul></div>

                    <div class="d-flex justify-content-between">
                        <button type="button" class="btn btn-secondary" onclick="prevStep()">Previous</button>
                        <button type="submit" class="btn btn-success" onclick="prepareAndSubmit(event)">Submit</button>

                    </div>
                </div>

                {{ form_end(form, { 'render_rest': false }) }}
            </div>

            <!-- Logs Tab -->
            <div class="tab-pane fade" id="logs-tab-pane" role="tabpanel">
                <table id="logsTable" class="table table-striped table-bordered table-hover" style="width:100%">
                    <thead class="table-dark">
                    <tr>
                        <th>ID</th>
                        <th>Created At</th>
                        <th>Company</th>
                        <th>Iproto ID</th>
                        <th>Locale</th>
                        <th>Status</th>
                        <th>Data (JSON)</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for log in logs %}
                        <tr>
                            <td>{{ log.id }}</td>
                            <td>{{ log.createdAt ? log.createdAt|date('Y-m-d H:i:s') : '' }}</td>
                            <td>{{ log.companyName }}</td>
                            <td>{{ log.iprotoId }}</td>
                            <td>{{ log.locale }}</td>
                            <td>
                                {% if log.status %}
                                    <span class="badge bg-info text-dark">{{ log.status }}</span>
                                {% else %}
                                    <span class="text-muted">N/A</span>
                                {% endif %}
                            </td>
                            <td>
                                {% set collapseId = 'collapse-log-' ~ log.id %}
                                <a class="btn btn-sm btn-outline-secondary"
                                   data-bs-toggle="collapse"
                                   href="#{{ collapseId }}"
                                   role="button"
                                   aria-expanded="false"
                                   aria-controls="{{ collapseId }}">
                                    ðŸ“‚ {{ log.data|length }} brochure{{ log.data|length > 1 ? 's' : '' }}
                                </a>
                                <div class="collapse mt-2" id="{{ collapseId }}">
                                    <ul class="list-group list-group-flush small border rounded">
                                        {% for brochure in log.data %}
                                            <li class="list-group-item d-flex justify-content-between">
                                                <span>#{{ loop.index }}: <strong>{{ brochure.number }}</strong></span>
                                                <span class="text-muted">Pixel: {{ brochure.tracking_pixel }}</span>
                                            </li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            </td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let currentStep = 0;

        function showStep(step) {
            for (let i = 0; i <= 3; i++) {
                const el = document.getElementById(`step-${i}`);
                el.style.display = (i === step ? 'block' : 'none');
            }

            document.querySelectorAll('#stepper .stepper-step').forEach((stepEl, index) => {
                stepEl.classList.remove('active', 'completed');
                if (index < step) {
                    stepEl.classList.add('completed');
                } else if (index === step) {
                    stepEl.classList.add('active');
                }
            });

            currentStep = step;
        }

        function prepareAndSubmit(e) {
            e.preventDefault();

            const form = document.querySelector('form');
            const steps = document.querySelectorAll('.step');
            const originalStep = currentStep;

            steps.forEach(step => step.style.display = 'block');

            const isValid = form.checkValidity();

            if (!isValid) {
                form.reportValidity();
                steps.forEach((step, index) => {
                    step.style.display = (index === originalStep ? 'block' : 'none');
                });
                return;
            }

            steps.forEach((step, index) => {
                step.style.display = (index === originalStep ? 'block' : 'none');
            });

            const submitBtn = e.target;
            submitBtn.classList.add('btn-loading');

            setTimeout(() => {
                form.submit();
            }, 50);
        }



        function nextStep(step = currentStep + 1) {
            const currentStepElement = document.getElementById(`step-${currentStep}`);
            const inputs = currentStepElement.querySelectorAll('input, select, textarea');

            let isValid = true;

            inputs.forEach(input => {
                const $input = $(input);
                const isSelect2 = $input.hasClass('select2-hidden-accessible');

                $input.next('.select2-container').find('.select2-selection').removeClass('is-invalid');
                $input.next('.select2-container').next('.select2-error-message')?.remove();

                if (isSelect2 && input.required && !input.value) {
                    isValid = false;

                    $input.next('.select2-container').find('.select2-selection')
                        .addClass('is-invalid');

                    const msg = document.createElement('div');
                    msg.className = 'text-danger select2-error-message mt-1';
                    msg.innerText = input.dataset.errorMessage || 'This field is required.';
                    $input.next('.select2-container').after(msg);
                }

                if (!isSelect2 && !input.checkValidity()) {
                    input.reportValidity();
                    if (input.offsetParent !== null) input.focus();
                    isValid = false;
                }
            });

            if (!isValid) return;

            if (step === 3) fillPreview();
            showStep(step);
        }




        function prevStep() {
            if (currentStep > 0) showStep(currentStep - 1);
        }

        function addNumberField() {
            const wrapper = document.getElementById('numbers-wrapper');
            const prototype = wrapper.dataset.prototype;
            const indexStart = wrapper.querySelectorAll('.number-entry[data-real="true"]').length;

            const bulkInput = document.getElementById('bulkNumbers');
            let inputValue = bulkInput?.value || '';
            const numbers = inputValue.split(',').map(s => s.trim()).filter(Boolean);

            if (numbers.length === 0) {
                const newForm = prototype.replace(/__name__/g, indexStart);
                const div = document.createElement('div');
                div.classList.add('number-entry', 'mb-2');
                div.setAttribute('data-real', 'true');
                div.innerHTML = newForm;
                wrapper.appendChild(div);
                return;
            }

            numbers.forEach((number, i) => {
                const index = indexStart + i;
                const newForm = prototype.replace(/__name__/g, index);
                const div = document.createElement('div');
                div.classList.add('number-entry', 'mb-2');
                div.setAttribute('data-real', 'true');
                div.innerHTML = newForm;

                const numberInput = div.querySelector('input[name$="[number]"]');
                if (numberInput) {
                    numberInput.value = number;
                }

                wrapper.appendChild(div);
            });

            if (bulkInput) bulkInput.value = '';
        }


        function fillPreview() {
            const companySelect = document.querySelector('[name$="[company]"]');
            const companyText = companySelect.options[companySelect.selectedIndex]?.text || '';
            document.getElementById('preview-company').textContent = companyText;

            const locale = document.querySelector('[name$="[locale]"]').value;
            document.getElementById('preview-locale').textContent = locale;

            const prefixInput = document.querySelector('[name$="[prefix]"]');
            const suffixInput = document.querySelector('[name$="[suffix]"]');

            const prefix = prefixInput?.value || '';
            const suffix = suffixInput?.value || '';

            document.getElementById('preview-prefix').textContent = prefix;
            document.getElementById('preview-suffix').textContent = suffix;

            const previewList = document.getElementById('preview-numbers');
            previewList.innerHTML = '';

            const wrappers = document.querySelectorAll('#numbers-wrapper .number-entry[data-real="true"]');
            let visibleIndex = 1;

            wrappers.forEach(block => {
                const numberInput = block.querySelector('input[name$="[number]"]');
                const pixelInput = block.querySelector('input[name$="[tracking_pixel]"]');
                if (!numberInput || !pixelInput) return;

                const number = numberInput.value.trim();
                const pixel = pixelInput.value.trim();

                if (number === '' && pixel === '') return;

                const item = document.createElement('li');
                item.classList.add('list-group-item');
                item.textContent = `#${visibleIndex++}: ${number} â€” Pixel: ${pixel}`;
                previewList.appendChild(item);
            });
        }

    </script>

    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            new DataTable('#logsTable', {
                responsive: true,
                pageLength: 10,
                order: [[1, 'desc']],
            });
        });
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const ownerSelect = document.querySelector('[name$="[owner]"]');
            const companySelect = document.querySelector('[name$="[company]"]');

            ownerSelect.addEventListener('change', async function () {
                const ownerId = this.value;
                companySelect.innerHTML = '<option value="">Loading companies...</option>';
                companySelect.disabled = true;

                try {
                    const response = await fetch(`/company/api/companies?owner=${encodeURIComponent(ownerId)}`);
                    const companies = await response.json();

                    companySelect.innerHTML = '<option value="">Select a company</option>';

                    companies.forEach(company => {
                        const option = document.createElement('option');
                        option.value = company.id;
                        option.textContent = company.label;
                        companySelect.appendChild(option);
                    });

                    companySelect.disabled = false;
                } catch (e) {
                    companySelect.innerHTML = '<option value="">Error loading companies</option>';
                    console.error('Error fetching companies:', e);
                }
                const timezoneInput = document.querySelector('[name$="[timezone]"]');

                try {
                    const response = await fetch(`/api/timezone?owner=${encodeURIComponent(ownerId)}`);
                    const data = await response.json();

                    timezoneInput.value = data.timezone || '';
                } catch (e) {
                    console.error('Failed to fetch timezone:', e);
                }
            });
        });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const $ownerSelect = $('[name$="[owner]"]');
            const $companySelect = $('[name$="[company]"]');

            $ownerSelect.select2({
                placeholder: 'Select an owner',
                allowClear: true,
                width: '100%'
            });

            $companySelect.select2({
                placeholder: 'Select a company',
                allowClear: true,
                width: '100%'
            });

            $ownerSelect.on('change', function () {
                this.setCustomValidity('');
            });
            $companySelect.on('change', function () {
                this.setCustomValidity('');
            });


            $ownerSelect.on('change', async function () {
                const ownerId = $(this).val();
                $companySelect.prop('disabled', true).empty().append(new Option('Loading companies...', '', false, false));

                try {
                    const response = await fetch(`/company/api/companies?owner=${encodeURIComponent(ownerId)}`);
                    const companies = await response.json();

                    $companySelect.empty().append(new Option('Select a company', '', true, false));

                    companies.forEach(company => {
                        const option = new Option(company.label, company.id, false, false);
                        $companySelect.append(option);
                    });

                    $companySelect.prop('disabled', false).trigger('change');
                } catch (error) {
                    console.error('Error loading companies:', error);
                    $companySelect.empty().append(new Option('Error loading companies', '', false, false));
                    $companySelect.prop('disabled', false);
                }
            });
        });
    </script>



{% endblock %}
