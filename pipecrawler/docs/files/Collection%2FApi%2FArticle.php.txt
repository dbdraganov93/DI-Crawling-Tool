<?php

class Marktjagd_Collection_Api_Article extends Marktjagd_Collection_Api_Abstract
{

    public function __construct()
    {
        $this->_headline = 'article_number;title;price;text;ean;manufacturer;article_number_manufacturer;'
            . 'suggested_retail_price;trademark;tags;color;size;amount;start;end;visible_start;visible_end;url;'
            . 'shipping;image;store_number;distribution;national';
    }

    /**
     * @param Marktjagd_Entity_Api_Article $element
     * @param boolean $group
     * @return bool
     */
    public function addElement($element, $group = true) {
        /* @var $logger Zend_Log */
        $logger = Zend_Registry::get('logger');

        $hash = $element->getHash();

        // skip empty elements
        if ($hash == 'd41d8cd98f00b204e9800998ecf8427e') {
            $logger->log('skip empty element', Zend_Log::DEBUG);
            return false;
        }

        // Wenn Hash noch nicht existiert => neues Element hinzufÃ¼gen
        if (!array_key_exists($hash, $this->_elements)) {
            $this->_elements[$hash] = $element;
            return true;
        } else {
            if ($group) {
                // Wenn gruppiert werden soll => Mergen der SO Nummern und danach aktuelles Element ersetzen
                $aStoreNumbersNew = preg_split('#\s*\,\s*#', $element->getStoreNumber());
                $aStoreNumbersOld = preg_split('#\s*\,\s*#', $this->_elements[$hash]->getStoreNumber());
                $aStoreNumbers = array_merge($aStoreNumbersOld, $aStoreNumbersNew);


                $element->setStoreNumber(implode(',', array_unique($aStoreNumbers)));
                $this->_elements[$hash] = $element;
                return true;
            } else {
                // Wenn Storenumber gesetzt und ungleich, dann neuen Eintrag mit neuem Hash anlegen
                if (strlen($element->getStoreNumber())
                    && $element->getStoreNumber() != $this->_elements[$hash]->getStoreNumber()
                ) {
                    $hashNew = md5($hash . uniqid());
                    $this->_elements[$hashNew] = $element;
                    return true;
                } else {
                    // Wenn Storenumber nicht gesetzt oder Storenumber gleich => Duplikatefehler
                    $logger->log('duplicate elements detected, want to add element with hash ' . $hash
                        , Zend_Log::DEBUG);
                    return false;
                }
            }

        }
    }
}
